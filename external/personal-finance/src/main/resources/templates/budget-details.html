<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title th:text="#{budget.details.title}">Budgets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/css/bootstrap-datepicker3.css">
    <link rel="icon" type="image/png" href="/images/my-logo.png" th:href="@{/images/my-logo.png}"/>
</head>
<body data-confirm-delete-title="Confirm deletion"
      data-confirm-delete-message="Are you sure you want to delete this item?"
      data-confirm-delete-confirm="Delete"
      data-confirm-delete-cancel="Cancel"
      th:attr="data-confirm-delete-title=#{common.confirmDeletionTitle}, data-confirm-delete-message=#{common.confirmDeletionMessage}, data-confirm-delete-confirm=#{common.delete}, data-confirm-delete-cancel=#{common.cancel}">
<div th:replace="blocks/header.html :: menu"></div>

<main class="container mt-5 mb-5">

    <div th:if="${budget == null || budgetDetails == null}" class="alert alert-danger" role="alert">
        <span th:text="#{budget.details.missing}">Budget details are unavailable.</span>
    </div>

    <div th:if="${budget != null and budgetDetails != null}">
        <h1 th:text="#{budget.details.heading}">Edit budget</h1>
        <form th:object="${budget}" th:method="put"
              th:action="${budget != null} ? @{/budgets/{id}(id=${budget.id})} : @{/budgets}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="input-append date" id="datepicker" data-date-format="mm-yyyy">
                <label class="form-label" for="month" th:text="#{budget.form.month.label}">Month</label>
                <input id="month" type="text" name="month" th:field="*{month}" class="form-control"
                       th:placeholder="#{budget.form.month.placeholder}"><br>
                <span class="add-on"><i class="icon-th"></i></span>
                <p class="md-text-danger" th:each="error: ${#fields.errors('month')}"
                   th:text="${error}">Validation error</p>
            </div>
            <div th:if="${errorMessage}" class="md-text-danger">
                <div th:text="${errorMessage}"></div>
            </div>

            <div class="alert alert-light" role="alert">
                <span th:text="#{budget.details.amountsHint(${baseCurrency})}">All amounts are shown in USD.</span>
            </div>
            <h2 th:text="#{budget.details.incomes}">Incomes</h2>
            <div class="table-responsive">
                <table class="table table-striped table-primary table-bordered">
                    <thead class="ttop">
                    <tr class="table-info">
                        <th class="w-40 text-center align-middle" th:text="#{budget.details.category}">Category</th>
                        <th class="w-20 text-center align-middle"
                            th:text="#{budget.details.plan(${baseCurrency})}">Plan ({0})</th>
                        <th class="w-20 text-center align-middle"
                            th:text="#{budget.details.fact(${baseCurrency})}">Fact ({0})</th>
                        <th class="w-20 text-center align-middle"
                            th:text="#{budget.details.planFact(${baseCurrency})}">Plan-Fact ({0})</th>
                    </tr>
                    </thead>
                    <tbody>

                    <tr th:each="el, st : ${budgetDetails.incomeBudgetCategories}"
                        th:classappend="${st.even} ? 'fw-normal' : ''">
                        <td>
                            <a th:if="${el.id != null}" th:text="${el.category.name}"
                               th:href="@{/budget/category/{id}(id=${el.id})}"></a>
                            <span th:if="${el.id == null}" th:text="${el.category.name}"></span>
                            <div class="text-muted small mt-1" th:if="${el.comment != null and !#strings.isEmpty(el.comment)}"
                                 th:text="${el.comment}"></div>
                        </td>
                        <td class="text-end align-middle">
                            <div class="d-flex justify-content-end align-items-center gap-2">
                                <a th:if="${el.id == null}" class="small"
                                   th:href="@{/budget/categories/add(budgetId=${budget.id}, type=${el.type}, categoryId=${el.category.id})}"
                                   th:text="#{budget.details.addPlanForCategory}"></a>
                                <span th:text="|${#numbers.formatDecimal(el.planAmountInBase, 1, 'COMMA', 2, 'POINT')} ${baseCurrency}|"></span>
                            </div>
                            <div class="text-muted small" th:if="${el.currency != null and el.currency != baseCurrency}">
                                <span th:text="|${#numbers.formatDecimal(el.planAmountOriginal, 1, 'COMMA', 2, 'POINT')} ${el.currency}|"></span>
                            </div>
                        </td>
                        <td class="text-end align-middle">
                            <a th:text="|${#numbers.formatDecimal(el.factAmountInBase, 1, 'COMMA', 2, 'POINT')} ${baseCurrency}|"
                               th:href="@{/transactionsByCategory(categoryId=${el.category.id}, month=${budget.month})}"></a>
                        </td>
                        <td class="text-end align-middle"
                            th:classappend="${el.leftoverInBase != null and el.leftoverInBase.compareTo(T(java.math.BigDecimal).ZERO) < 0} ? 'md-text-danger text-danger' : ''"
                            th:text="|${#numbers.formatDecimal(el.leftoverInBase, 1, 'COMMA', 2, 'POINT')} ${baseCurrency}|"></td>
                    </tr>
                    <tr class="table-default fw-bold">
                        <td class="text-end" th:text="#{budget.details.total}">Total:</td>
                        <td th:text="|${#numbers.formatDecimal(totalIncome, 1, 'COMMA', 2, 'POINT')} ${baseCurrency}|"
                            class="text-end align-middle"></td>
                        <td th:text="|${#numbers.formatDecimal(incomeFactTotal, 1, 'COMMA', 2, 'POINT')} ${baseCurrency}|"
                            class="text-end align-middle"></td>
                        <td th:text="|${#numbers.formatDecimal(totalIncome - incomeFactTotal, 1, 'COMMA', 2, 'POINT')} ${baseCurrency}|"
                            class="text-end align-middle"
                            th:classappend="${totalIncome != null and incomeFactTotal != null and totalIncome.compareTo(incomeFactTotal) < 0} ? ' md-text-danger text-danger' : ''"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <a class="btn md-btn md-btn-primary my-3"
               th:if="${budget != null}"
               th:href="@{/budget/categories/add(budgetId=${budget.id}, type=${'INCOME'})}" role="button"
               th:text="#{budget.details.addIncome}">Add</a>
            <h2 th:text="#{budget.details.expenses}">Expenses</h2>
            <div class="table-responsive">
                <table class="table table-striped table-primary table-bordered">
                    <thead class="ttop">
                    <tr class="table-info">
                        <th class="w-40 text-center align-middle" th:text="#{budget.details.category}">Category</th>
                        <th class="w-20 text-center align-middle"
                            th:text="#{budget.details.plan(${baseCurrency})}">Plan ({0})</th>
                        <th class="w-20 text-center align-middle"
                            th:text="#{budget.details.fact(${baseCurrency})}">Fact ({0})</th>
                        <th class="w-20 text-center align-middle"
                            th:text="#{budget.details.planFact(${baseCurrency})}">Plan-Fact ({0})</th>
                    </tr>
                    </thead>
                    <tbody>

                    <tr th:each="el, st : ${budgetDetails.expenseBudgetCategories}"
                        th:classappend="${st.even} ? 'fw-normal' : ''">
                        <td>
                            <a th:if="${el.id != null}" th:text="${el.category.name}"
                               th:href="@{/budget/category/{id}(id=${el.id})}"></a>
                            <span th:if="${el.id == null}" th:text="${el.category.name}"></span>
                            <div class="text-muted small mt-1" th:if="${el.comment != null and !#strings.isEmpty(el.comment)}"
                                 th:text="${el.comment}"></div>
                        </td>
                        <td class="text-end align-middle">
                            <div class="d-flex justify-content-end align-items-center gap-2">
                                <a th:if="${el.id == null}" class="small"
                                   th:href="@{/budget/categories/add(budgetId=${budget.id}, type=${el.type}, categoryId=${el.category.id})}"
                                   th:text="#{budget.details.addPlanForCategory}"></a>
                                <span th:text="|${#numbers.formatDecimal(el.planAmountInBase, 1, 'COMMA', 2, 'POINT')} ${baseCurrency}|"></span>
                            </div>
                            <div class="text-muted small" th:if="${el.currency != null and el.currency != baseCurrency}">
                                <span th:text="|${#numbers.formatDecimal(el.planAmountOriginal, 1, 'COMMA', 2, 'POINT')} ${el.currency}|"></span>
                            </div>
                        </td>
                        <td class="text-end align-middle">
                            <a th:text="|${#numbers.formatDecimal(el.factAmountInBase, 1, 'COMMA', 2, 'POINT')} ${baseCurrency}|"
                               th:href="@{/transactionsByCategory(categoryId=${el.category.id}, month=${budget.month})}"></a>
                        </td>
                        <td class="text-end align-middle"
                            th:classappend="${el.leftoverInBase != null and el.leftoverInBase.compareTo(T(java.math.BigDecimal).ZERO) < 0} ? 'md-text-danger text-danger' : ''"
                            th:text="|${#numbers.formatDecimal(el.leftoverInBase, 1, 'COMMA', 2, 'POINT')} ${baseCurrency}|"></td>

                    </tr>

                    <tr class="table-default fw-bold">
                        <td class="text-end" th:text="#{budget.details.total}">Total:</td>
                        <td th:text="|${#numbers.formatDecimal(totalExpenses, 1, 'COMMA', 2, 'POINT')} ${baseCurrency}|"
                            class="text-end align-middle"></td>
                        <td th:text="|${#numbers.formatDecimal(expenseFactTotal, 1, 'COMMA', 2, 'POINT')} ${baseCurrency}|"
                            class="text-end align-middle"></td>
                        <td th:text="|${#numbers.formatDecimal(totalExpenses - expenseFactTotal, 1, 'COMMA', 2, 'POINT')} ${baseCurrency}|"
                            class="text-end align-middle"
                            th:classappend="${totalExpenses != null and expenseFactTotal != null and totalExpenses.compareTo(expenseFactTotal) < 0} ? ' md-text-danger text-danger' : ''"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <a class="btn md-btn md-btn-primary my-3"
               th:if="${budget != null}"
               th:href="@{/budget/categories/add(budgetId=${budget.id}, type=${'EXPENSES'})}" role="button"
               th:text="#{budget.details.addExpense}">Add</a>

            <a th:if="${budget != null}"
               th:href="@{/budgets/{id}/copy(id=${budget.id})}" class="btn md-btn md-btn-info" role="button"
               th:text="#{budget.details.clone}">Clone budget</a>

        </form>
        <br>
        <form th:if="${budget != null}" th:action="@{/budgets/{id}(id=${budget.id})}" th:method="delete"
              data-confirm-delete>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="btn md-btn md-btn-danger" th:text="#{budget.details.delete}">Delete budget</button>
        </form>

    </div>
</main>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js" type="text/javascript"></script>
<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="Stylesheet"
      type="text/css"/>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
<script defer th:src="@{/js/confirm-delete.js}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.2.0/js/bootstrap-datepicker.min.js"></script>

<script type="text/javascript">
    $(function () {
        $("#datepicker").datepicker({
            format: "mm-yyyy",
            startView: "months",
            minViewMode: "months",
            autoclose: true
        });
    });
</script>
</body>
</html>
