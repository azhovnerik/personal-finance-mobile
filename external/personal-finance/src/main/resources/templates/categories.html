<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="#{categories.title}">Categories</title>

    <link th:rel="stylesheet" th:href="@{assets/jquery-treetable/jquery.treetable.css}"/>
    <link th:rel="stylesheet" th:href="@{assets/jquery-treetable/jquery.treetable.theme.default.css}"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/tables.css}"/>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" th:href="@{/images/favicon.svg}"/>
    <link rel="icon" type="image/png" href="/images/my-logo.png" th:href="@{/images/my-logo.png}"/>

</head>
<body>
<div th:replace="blocks/header.html :: menu"></div>

<main class="container py-4">
    <div class="table-toolbar">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <h1 class="mb-0" th:text="#{categories.heading}">Categories</h1>
            <span class="badge badge-soft d-inline-flex align-items-center gap-2">
                <i class="bi bi-collection"></i>
                <span th:text="#{categories.title}">Categories</span>
            </span>
        </div>
        <div class="toolbar-actions">
            <div class="form-check form-switch mb-0">
                <input type="checkbox" id="disabled" name="disabled"
                       class="form-check-input" onclick="handleClick(this);">
                <label class="form-check-label" for="disabled" th:text="#{categories.showDisabled}">Show disabled</label>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12 col-lg-6">
            <div class="table-toolbar">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h2 class="mb-0" th:text="#{categories.income}">Income</h2>
                    <span class="badge badge-soft-success d-inline-flex align-items-center gap-2">
                        <i class="bi bi-graph-up-arrow"></i>
                        <span th:text="#{categories.income}">Income</span>
                    </span>
                </div>
                <div class="toolbar-actions">
                    <a class="btn md-btn md-btn-primary" th:href="'/categories/add?type=INCOME'" role="button">
                        <i class="bi bi-plus-lg me-2"></i>
                        <span th:text="#{categories.create}">Create category</span>
                    </a>
                </div>
            </div>
            <div class="table-responsive table-responsive-card">
                <table id="treeTable"
                       class="table table-hover table-zebra table-card table-sticky align-middle category-tree">
                    <thead>
                    <tr>
                        <th scope="col" th:text="#{categories.table.name}">Name</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="table-toolbar">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h2 class="mb-0" th:text="#{categories.expenses}">Expenses</h2>
                    <span class="badge badge-soft-danger d-inline-flex align-items-center gap-2">
                        <i class="bi bi-graph-down-arrow"></i>
                        <span th:text="#{categories.expenses}">Expenses</span>
                    </span>
                </div>
                <div class="toolbar-actions">
                    <a class="btn md-btn md-btn-primary" th:href="'/categories/add?type=EXPENSES'" role="button">
                        <i class="bi bi-plus-lg me-2"></i>
                        <span th:text="#{categories.create}">Create category</span>
                    </a>
                </div>
            </div>
            <div class="table-responsive table-responsive-card">
                <table id="treeTable2"
                       class="table table-hover table-zebra table-card table-sticky align-middle category-tree">
                    <thead>
                    <tr>
                        <th scope="col" th:text="#{categories.table.name}">Name</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script th:src="@{/webjars/jquery/jquery.min.js}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
<script th:src="@{/assets/jquery-treetable/jquery.treetable.js}"></script>


<script type="text/javascript" th:inline="javascript">
    const i18n = {
        createSubcategory: /*[[#{categories.createSubcategory}]]*/ 'Create subcategory',
        name: /*[[#{categories.table.name}]]*/ 'Name'
    };

    function computeCategoryIconStyle(iconKey, type) {
        const seed = (iconKey || '') + (type || '');
        let hash = 0;
        for (let i = 0; i < seed.length; i++) {
            hash = seed.charCodeAt(i) + ((hash << 5) - hash);
        }
        const hue = Math.abs(hash % 360);
        const primary = `hsl(${hue}, 75%, 52%)`;
        const secondary = `hsl(${hue}, 85%, 62%)`;
        return `background: linear-gradient(135deg, ${primary} 0%, ${secondary} 100%);`;
    }

    function decorateTree(tableSelector) {
        const $table = $(tableSelector);
        $table.find('tbody tr').each(function () {
            const $cell = $(this).children('td').first();
            const $indenter = $cell.children('.indenter');
            const $row = $cell.find('.category-row');
            if ($indenter.length && $row.length) {
                $row.prepend($indenter);
            }
        });
    }

    $(window).bind('beforeunload', function () {
        var checkboxValue = $("#disabled").is(":checked");
        $.cookie('checkboxValue', checkboxValue, {expires: 7, path: '/'})

    });

    function handleClick(cb) {
        $.cookie('checkboxValue', cb.checked, {expires: 7, path: '/'});
        getCategoryListIncome(cb.checked);
        getCategoryListExpenses(cb.checked);
    }

    function repopulateCheckboxes() {
        var checkboxValue = $.cookie('checkboxValue');
        if (checkboxValue) {
            var checked = checkboxValue;
            $("#disabled").attr('checked', checked === "true");
        }
    }

    $(document).ready(populateTable);

    function populateTable() {
        repopulateCheckboxes();
        getCategoryListIncome($.cookie('checkboxValue'));
        getCategoryListExpenses($.cookie('checkboxValue'));
    }

    function createCategoryRow(obj, type) {
        const isRoot = obj.parentId == null;
        const iconClass = obj.icon ? obj.icon : (type === 'EXPENSES' ? 'bi-wallet2' : 'bi-piggy-bank-fill');
        const iconStyle = computeCategoryIconStyle(obj.icon || obj.name || obj.id, type);
        const actionCell = isRoot ? `<a class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-2 create-subcategory" href="/categories/add?type=${type}&parentId=${obj.id}" onclick="event.stopPropagation();">
                                <i class="bi bi-node-plus me-1"></i>${i18n.createSubcategory}
                            </a>` : '';

        return `<tr data-tt-id="${obj.id}" data-tt-parent-id="${obj.parentId}">
                    <td data-label="${i18n.name}">
                        <div class="category-row">
                            <span class="category-node flex-grow-1" onclick="event.stopPropagation();">
                                <span class="category-icon" style="${iconStyle}">
                                    <i class="bi ${iconClass}"></i>
                                </span>
                                <a class="text-decoration-none" href="/categories/${obj.id}?type=${type}">${obj.name}</a>
                            </span>
                            ${actionCell}
                        </div>
                    </td>
                </tr>`;
    }

    function getCategoryListExpenses(withDisabled) {
        $("#treeTable2 tbody").empty();
        $.ajax({
            "type": 'get',
            "url": '/api/v1/categories?type=expenses&disabled=' + withDisabled,
            "dataType": "json",
            "success": function (data) {

                $.each(data.categoryDtoList, function (idx, obj) {
                    $("#treeTable2 tbody").append(createCategoryRow(obj, 'EXPENSES'));
                });
                $("#treeTable2").treetable({
                    expandable: true,
                    initialState: "expanded",
                    clickableNodeNames: true,
                    indent: 30,
                }, true);
                decorateTree('#treeTable2');

            }
        });
    }

    function getCategoryListIncome(disabled) {
        $("#treeTable tbody").empty();
        $.ajax({
            "type": 'get',
            "url": '/api/v1/categories?type=income&disabled=' + disabled,
            "dataType": "json",
            "success": function (data) {
                $.each(data.categoryDtoList, function (idx, obj) {
                    $("#treeTable tbody").append(createCategoryRow(obj, 'INCOME'));
                });
                $("#treeTable").treetable({
                    expandable: true,
                    initialState: "expanded",
                    clickableNodeNames: true,
                    indent: 30
                }, true);
                decorateTree('#treeTable');
            }
        });
    }
</script>


</body>
</html>
