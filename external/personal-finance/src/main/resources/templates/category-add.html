<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="#{categories.form.add.title}">Add category</title>

    <!-- Bootstrap 5 -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          crossorigin="anonymous">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
          crossorigin="anonymous">

    <link rel="stylesheet" th:href="@{/css/tables.css}"/>
</head>

<body>
<div th:replace="blocks/header.html :: menu"></div>

<div class="container mt-5 mb-4">
    <h1 class="mb-4" th:text="#{categories.form.add.heading}">Add new category</h1>

    <!-- ВАЖНО: действие формы соответствует @PostMapping("/categories") -->
    <form th:action="@{/categories}" th:object="${category}" method="post" class="needs-validation" novalidate>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!-- Name -->
        <div class="mb-3">
            <label for="name" class="form-label" th:text="#{categories.form.name.label}">Name</label>
            <input id="name" type="text" th:field="*{name}" class="form-control" th:placeholder="#{categories.form.name.placeholder}" required>
            <p class="md-text-danger mb-0" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">Validation error</p>
        </div>

        <!-- Global error -->
        <div class="mb-3" th:if="${errorMessage}">
            <div class="alert alert-danger" th:text="${errorMessage}"></div>
        </div>

        <!-- Description -->
        <div class="mb-3">
            <label for="description" class="form-label" th:text="#{categories.form.description.label}">Description</label>
            <input id="description" type="text" th:field="*{description}" class="form-control" th:placeholder="#{categories.form.description.placeholder}">
            <p class="md-text-danger mb-0" th:if="${#fields.hasErrors('description')}" th:errors="*{description}">Validation error</p>
        </div>

        <!-- Type (readonly) -->
        <div class="mb-3">
            <label for="type" class="form-label" th:text="#{categories.form.type.label}">Type</label>
            <input id="type" type="text" th:field="*{type}" class="form-control" readonly>
        </div>

        <!-- Parent category id (если не нужно — удалите блок) -->
        <div class="mb-3">
            <label for="parentId" class="form-label" th:text="#{categories.form.parent.label}">Parent category</label>
            <input id="parentId" type="text" th:field="*{parentId}" class="form-control" readonly>
        </div>

        <div class="mb-3">
            <label for="icon" class="form-label" th:text="#{categories.form.icon.label}">Icon</label>
            <input type="hidden" id="icon" th:field="*{icon}"/>
            <div class="dropdown icon-picker-dropdown">
                <button class="btn md-btn md-btn-outline md-btn-outline-secondary d-flex align-items-center gap-2"
                        type="button" id="iconPickerToggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="icon-preview-pill" id="iconPreview">
                        <i class="bi"></i>
                    </span>
                    <span th:text="#{categories.form.icon.change}">Change</span>
                </button>
                <div class="dropdown-menu p-3">
                    <div class="icon-picker-grid">
                        <button type="button" class="icon-option" th:each="ic : ${icons}"
                                th:attr="data-icon=${ic},data-icon-seed=${ic}">
                            <i class="bi" th:classappend="' ' + ${ic}"></i>
                        </button>
                    </div>
                </div>
            </div>
            <p class="form-text mt-2" th:text="#{categories.form.icon.preview}">Preview</p>
            <p class="md-text-danger mb-0" th:if="${#fields.hasErrors('icon')}" th:errors="*{icon}">Validation error</p>
        </div>

        <!-- Disabled -->
        <div class="form-check mb-4">
            <input id="disabled" type="checkbox" th:field="*{disabled}" class="form-check-input">
            <label class="form-check-label" for="disabled" th:text="#{categories.form.disabled.label}">Disabled</label>
        </div>

        <button type="submit" class="btn md-btn md-btn-primary" th:text="#{common.save}">Save</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script>
    const iconInput = document.getElementById('icon');
    const iconPreview = document.getElementById('iconPreview');
    const iconPreviewIcon = iconPreview ? iconPreview.querySelector('i') : null;
    const iconButtons = document.querySelectorAll('.icon-option');
    const dropdownToggle = document.getElementById('iconPickerToggle');
    const dropdown = dropdownToggle ? bootstrap.Dropdown.getOrCreateInstance(dropdownToggle) : null;

    function computeIconGradient(seed) {
        const source = seed || 'moneydrive';
        let hash = 0;
        for (let i = 0; i < source.length; i++) {
            hash = source.charCodeAt(i) + ((hash << 5) - hash);
        }
        const hue = Math.abs(hash % 360);
        const secondaryHue = (hue + 25) % 360;
        const primary = `hsl(${hue}, 78%, 54%)`;
        const secondary = `hsl(${secondaryHue}, 82%, 62%)`;
        return `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
    }

    function setIconValue(value) {
        if (!iconInput || !iconPreviewIcon) {
            return;
        }
        iconInput.value = value || '';
        iconPreviewIcon.className = value ? 'bi ' + value : 'bi';
        iconPreview.style.background = computeIconGradient(value || 'default');
        iconButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.icon === value));
    }

    iconButtons.forEach(btn => {
        const seed = btn.dataset.iconSeed || btn.dataset.icon;
        btn.style.background = computeIconGradient(seed);
        btn.addEventListener('click', () => {
            const icon = btn.dataset.icon || '';
            setIconValue(icon);
            if (dropdown) {
                dropdown.hide();
            }
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        setIconValue(iconInput ? iconInput.value : '');
    });
</script>

</body>
</html>
