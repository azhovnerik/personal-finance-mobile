<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="#{categories.form.edit.title}">Edit category</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
          crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
    <!-- Datepicker (если используется где-то ещё на странице) -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/css/bootstrap-datepicker3.css">
    <link href="/css/dashboard.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/tables.css}"/>
    <link rel="icon" type="image/png" href="/images/my-logo.png" th:href="@{/images/my-logo.png}"/>
</head>

<body data-confirm-delete-title="Confirm deletion"
      data-confirm-delete-message="Are you sure you want to delete this item?"
      data-confirm-delete-confirm="Delete"
      data-confirm-delete-cancel="Cancel"
      th:attr="data-confirm-delete-title=#{common.confirmDeletionTitle}, data-confirm-delete-message=#{common.confirmDeletionMessage}, data-confirm-delete-confirm=#{common.delete}, data-confirm-delete-cancel=#{common.cancel}">
<div th:replace="blocks/header.html :: menu"></div>

<div class="container mt-5 mb-3">
    <h1 th:text="#{categories.form.edit.heading}">Edit category</h1>

    <!-- Форма редактирования -->
    <form th:object="${category}" th:action="@{/categories/{id}(id=${category.id})}" th:method="put">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <label for="name" th:text="#{categories.form.name.label}">Name</label>
        <input type="text" th:field="*{name}" id="name" name="name" class="form-control" th:placeholder="#{categories.form.name.placeholder}">
        <p class="md-text-danger" th:each="error: ${#fields.errors('name')}"
           th:text="${error}">Validation error</p>

        <div th:if="${errorMessage}" class="md-text-danger mb-2" th:text="${errorMessage}"></div>

        <label for="description" th:text="#{categories.form.description.label}">Description</label>
        <input type="text" name="description" id="description" th:field="*{description}" class="form-control"
               th:placeholder="#{categories.form.description.placeholder}">

        <label for="type" class="mt-3" th:text="#{categories.form.type.label}">Type</label>
        <input type="text" id="type" name="type" th:field="*{type}"
               class="form-control" readonly>

        <!-- Текущий parentId (readonly, скрытый) -->
        <input type="text" id="parentId" name="parentId"
               th:field="*{parentId}" class="form-control" hidden>

        <!-- Новый родитель -->
        <label for="newParentId" class="mt-3" th:text="#{categories.form.parent.label}">Parent category</label>
        <select id="newParentId" name="newParentId" class="form-select">
            <option value="null" th:text="#{categories.form.parent.none}">None</option>
            <option th:each="i : ${rootCategories}"
                    th:value="${i.id}"
                    th:text="${i.name}"
                    th:selected="${i==currentParent}"></option>
        </select>

        <label for="iconDropdown" class="mt-3" th:text="#{categories.form.icon.label}">Icon</label>
        <input type="hidden" th:field="*{icon}" id="icon"/>

        <div class="dropdown icon-picker-dropdown mb-3">
            <button class="btn md-btn md-btn-outline md-btn-outline-secondary d-flex align-items-center gap-2"
                    type="button" id="iconDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="icon-preview-pill" id="iconPreview">
                    <i class="bi" th:classappend="' ' + ${category.icon}"></i>
                </span>
                <span class="small" th:text="#{categories.form.icon.change}">Change</span>
            </button>

            <div class="dropdown-menu p-3" style="min-width: 280px;">
                <div class="icon-picker-grid">
                    <button type="button" class="icon-option"
                            th:each="ic : ${icons}" th:attr="data-icon=${ic},data-icon-seed=${ic}">
                        <i class="bi" th:classappend="' ' + ${ic}"></i>
                    </button>
                </div>
            </div>
        </div>

        <label for="disabled" th:text="#{categories.form.disabled.label}">Disabled</label>
        <input type="checkbox" id="disabled" name="disabled" th:field="*{disabled}" class="form-check-input">

        <div class="mt-4">
            <button type="submit" class="btn md-btn md-btn-success" th:text="#{common.save}">Save</button>
        </div>
    </form>

    <!-- Удаление категории -->
    <form class="mt-3"
          th:action="@{/categories/{id}(id=${category.id})}"
          th:method="delete" th:object="${category}" data-confirm-delete>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit" class="btn md-btn md-btn-danger" th:text="#{categories.form.delete}">Delete category</button>
    </form>
</div>

<!-- Скрипты -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
        integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
<script defer th:src="@{/js/confirm-delete.js}"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const hidden = document.getElementById('icon');
        const preview = document.getElementById('iconPreview');
        const previewIcon = preview ? preview.querySelector('i') : null;
        const toggle = document.getElementById('iconDropdown');
        const dropdown = bootstrap.Dropdown.getOrCreateInstance(toggle);
        const buttons = document.querySelectorAll('.icon-option');

        function computeIconGradient(seed) {
            const source = seed || 'moneydrive';
            let hash = 0;
            for (let i = 0; i < source.length; i++) {
                hash = source.charCodeAt(i) + ((hash << 5) - hash);
            }
            const hue = Math.abs(hash % 360);
            const secondaryHue = (hue + 25) % 360;
            const primary = `hsl(${hue}, 78%, 54%)`;
            const secondary = `hsl(${secondaryHue}, 82%, 62%)`;
            return `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
        }

        function setIcon(val) {
            if (!previewIcon) {
                return;
            }
            hidden.value = val || '';
            previewIcon.className = 'bi ' + (val || '');
            preview.style.background = computeIconGradient(val || 'default');
            buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.icon === val));
        }

        buttons.forEach(btn => {
            const seed = btn.dataset.iconSeed || btn.dataset.icon;
            btn.style.background = computeIconGradient(seed);
            btn.addEventListener('click', () => {
                setIcon(btn.dataset.icon || '');
                dropdown.hide();
            });
        });

        setIcon(hidden.value);
    });
</script>
</body>
</html>
