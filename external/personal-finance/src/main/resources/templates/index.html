<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="#{nav.dashboard}">Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="icon" type="image/png" href="/images/my-logo.png" th:href="@{/images/my-logo.png}"/>
</head>

<body class="dashboard-body">
    <header th:insert="blocks/header :: menu"></header>
    <div class="container py-4">

    <div sec:authorize="!isAuthenticated()" class="text-center py-5">
        <h1 class="display-5 mb-3" th:text="#{dashboard.guest.heading}">Welcome to MoneyDrive.me</h1>
        <p class="text-muted mb-4" th:text="#{dashboard.guest.description}">
            Sign in to manage your accounts, track budgets, and visualise your spending trends.
        </p>
        <a class="btn md-btn md-btn-primary md-btn-lg" th:href="@{/login}" th:text="#{dashboard.guest.signIn}">Sign in</a>
    </div>

    <div sec:authorize="isAuthenticated()">
        <form id="logoutForm" method="POST" th:action="@{/logout}">
            <input type="hidden" name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        </form>

        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3 dashboard-header">
            <div>
                <h1 class="mb-1"
                    th:text="#{dashboard.welcome(${@userView.displayName(#authentication.name)})}">Welcome back, User</h1>
                <p class="text-muted mb-0" th:if="${dashboard != null}"
                   th:text="#{dashboard.dateRange(${#temporals.format(dashboard.startDate, 'MMM d, yyyy')}, ${#temporals.format(dashboard.endDate, 'MMM d, yyyy')})}"></p>
            </div>
            <button class="btn md-btn md-btn-outline md-btn-outline-danger" type="button" onclick="document.getElementById('logoutForm').submit()"
                    th:text="#{common.logout}">
                Logout
            </button>
        </div>

        <form class="row g-3 align-items-end mb-4" th:if="${dashboard != null}" method="get">
            <div class="col-md-3 col-sm-6">
                <label for="startDate" class="form-label" th:text="#{common.startDate}">Start date</label>
                <input type="date" class="form-control" id="startDate" name="startDate" th:value="${startDate}">
            </div>
            <div class="col-md-3 col-sm-6">
                <label for="endDate" class="form-label" th:text="#{common.endDate}">End date</label>
                <input type="date" class="form-control" id="endDate" name="endDate" th:value="${endDate}">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn md-btn md-btn-primary" th:text="#{common.apply}">Apply</button>
            </div>
        </form>

        <div class="card dashboard-card quick-actions mb-4" th:if="${dashboard != null}">
            <div class="card-body d-flex flex-wrap gap-2 align-items-center">
                <h5 class="card-title mb-0 me-3" th:text="#{dashboard.quickActions.title}">Quick actions</h5>
                <a class="btn md-btn md-btn-outline md-btn-outline-primary" th:href="@{/transactions/add}" th:text="#{dashboard.quickActions.addTransaction}">Add transaction</a>
                <a class="btn md-btn md-btn-outline md-btn-outline-secondary" th:href="@{/budgets}" th:text="#{dashboard.quickActions.manageBudgets}">Manage budgets</a>
                <a class="btn md-btn md-btn-outline md-btn-outline-success" th:href="@{/accounts/add}" th:text="#{dashboard.quickActions.addAccount}">Add account</a>
                <a class="btn md-btn md-btn-outline md-btn-outline-info" th:href="@{/categories}" th:text="#{dashboard.quickActions.browseCategories}">Browse categories</a>
            </div>
        </div>

        <div class="row g-3 mb-4" th:if="${dashboard != null}">
            <div class="col-lg-4 col-md-6">
                <div class="card dashboard-card summary-card h-100">
                    <div class="card-body">
                        <h6 class="card-title text-muted" th:text="#{dashboard.summary.totalBalance}">Total balance</h6>
                        <p class="summary-value mb-1"
                           th:text="|${#numbers.formatDecimal(dashboard.totalBalance, 1, 'COMMA', 2, 'POINT')} ${dashboard.baseCurrency}|"></p>
                        <p class="summary-subtext text-muted mb-0" th:text="#{dashboard.summary.totalBalance.help}">Across all accounts</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="card dashboard-card summary-card h-100">
                    <div class="card-body">
                        <h6 class="card-title text-muted" th:text="#{dashboard.summary.income}">Income this period</h6>
                        <p class="summary-value md-text-success mb-1"
                           th:text="|${#numbers.formatDecimal(dashboard.totalIncome, 1, 'COMMA', 2, 'POINT')} ${dashboard.baseCurrency}|"></p>
                        <p class="summary-subtext text-muted mb-0" th:text="#{dashboard.summary.income.help}">All recorded income categories</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="card dashboard-card summary-card h-100">
                    <div class="card-body">
                        <h6 class="card-title text-muted" th:text="#{dashboard.summary.expenses}">Expenses this period</h6>
                        <p class="summary-value md-text-danger mb-1"
                           th:text="|${#numbers.formatDecimal(dashboard.totalExpenses, 1, 'COMMA', 2, 'POINT')} ${dashboard.baseCurrency}|"></p>
                        <p class="summary-subtext text-muted mb-0" th:text="#{dashboard.summary.expenses.help}">Spending across all accounts</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card dashboard-card mb-4" th:if="${dashboard != null}">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <h5 class="mb-0" th:text="#{dashboard.accounts.title}">Accounts</h5>
                <a class="btn md-btn md-btn-outline md-btn-outline-primary md-btn-sm" th:href="@{/accounts/add}" th:text="#{dashboard.accounts.add}">Add account</a>
            </div>
            <div class="card-body pt-0">
                <div class="row g-3" th:if="${!#lists.isEmpty(dashboard.accounts)}">
                    <div class="col-xl-3 col-lg-4 col-md-6" th:each="account : ${dashboard.accounts}">
                        <div class="card account-card h-100">
                            <div class="card-body">
                                <p class="text-muted text-uppercase small mb-1" th:text="${account.type}">CASH</p>
                                <h5 class="mb-2" th:text="${account.name}">Main account</h5>
                                <p class="account-balance mb-0"
                                   th:text="|${#numbers.formatDecimal(account.balance, 1, 'COMMA', 2, 'POINT')} ${account.currency}|"></p>
                                <div class="text-muted small"
                                     th:if="${account.currency != null and account.currency != dashboard.baseCurrency}"
                                     th:text="|≈ ${#numbers.formatDecimal(account.balanceInBase, 1, 'COMMA', 2, 'POINT')} ${dashboard.baseCurrency}|"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="text-muted mb-0" th:if="${#lists.isEmpty(dashboard.accounts)}"
                   th:text="#{dashboard.accounts.empty}">
                    You haven't added any accounts yet.
                </p>
            </div>
        </div>

        <div class="row g-3 mb-4" th:if="${dashboard != null}">
            <div class="col-lg-8">
                <div class="card dashboard-card chart-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0" th:text="#{dashboard.breakdown.title}">Spending &amp; income breakdown</h5>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn md-btn md-btn-outline md-btn-outline-primary active" data-breakdown="expenses"
                                        th:text="#{common.expenses}">Expenses</button>
                                <button type="button" class="btn md-btn md-btn-outline md-btn-outline-primary" data-breakdown="income"
                                        th:text="#{common.income}">Income</button>
                            </div>
                        </div>
                        <p class="text-muted small mb-3"
                           th:text="#{dashboard.breakdown.allAmounts(${dashboard.baseCurrency})}">All amounts in USD.</p>
                        <div class="chart-wrapper">
                            <canvas id="breakdownChart" height="260"></canvas>
                        </div>
                        <div id="breakdownList" class="mt-3">
                            <p class="text-muted mb-0" th:if="${#lists.isEmpty(dashboard.expenseBreakdown)}"
                               th:text="#{dashboard.breakdown.empty}">
                                No data available for this selection.
                            </p>
                            <div th:each="category : ${dashboard.expenseBreakdown}"
                                 class="d-flex justify-content-between align-items-center breakdown-row">
                                <span class="fw-semibold" th:text="${category.name}">Groceries</span>
                                <span class="text-muted"
                                      th:text="|${#numbers.formatDecimal(category.amount, 1, 'COMMA', 2, 'POINT')} ${dashboard.baseCurrency}|"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card dashboard-card h-100">
                    <div class="card-body">
                        <h5 class="card-title" th:text="#{dashboard.popularCategories.title}">Popular categories</h5>
                        <p class="text-muted small mb-3"
                           th:text="#{dashboard.popularCategories.subtitle(${dashboard.baseCurrency})}">
                            Top categories by spending (USD)
                        </p>
                        <div th:if="${#lists.isEmpty(dashboard.topExpenseCategories)}" class="text-muted"
                             th:text="#{dashboard.popularCategories.empty}">
                            No expenses recorded for this period.
                        </div>
                        <div th:each="category, stat : ${dashboard.topExpenseCategories}" class="popular-category">
                            <span class="fw-semibold" th:text="|${stat.index + 1}. ${category.name}|">1. Groceries</span>
                            <span class="fw-semibold md-text-danger"
                                  th:text="|${#numbers.formatDecimal(category.amount, 1, 'COMMA', 2, 'POINT')} ${dashboard.baseCurrency}|"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4" th:if="${dashboard != null}">
            <div class="col-lg-6">
                <div class="card dashboard-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0" th:text="#{dashboard.budgets.title}">Budget progress</h5>
                            <a class="btn md-btn md-btn-outline md-btn-outline-primary md-btn-sm" th:href="@{/budgets}" th:text="#{dashboard.budgets.view}">View budgets</a>
                        </div>
                        <div th:if="${#lists.isEmpty(dashboard.budgetProgress)}" class="text-muted"
                             th:text="#{dashboard.budgets.empty}">
                            You don't have any budgets for this month yet.
                        </div>
                        <div th:each="budget : ${dashboard.budgetProgress}" class="budget-progress mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0" th:text="${budget.monthLabel}">May 2024</h6>
                                <span class="badge md-badge-light"
                                      th:text="|${#numbers.formatDecimal(budget.actualExpense, 1, 'COMMA', 2, 'POINT')} / ${#numbers.formatDecimal(budget.plannedExpense, 1, 'COMMA', 2, 'POINT')} ${budget.baseCurrency}|"></span>
                            </div>
                            <div class="progress mt-2" style="height: 0.75rem;">
                                <div class="progress-bar bg-danger" role="progressbar"
                                     th:style="|width:${budget.expenseCompletionPercent}%|"
                                     th:aria-valuenow="${budget.expenseCompletionPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2 small text-muted">
                                <span th:text="#{common.income}">Income</span>
                                <span th:text="|${#numbers.formatDecimal(budget.actualIncome, 1, 'COMMA', 2, 'POINT')} / ${#numbers.formatDecimal(budget.plannedIncome, 1, 'COMMA', 2, 'POINT')} ${budget.baseCurrency}|"></span>
                            </div>
                            <div class="progress mt-1" style="height: 0.5rem;">
                                <div class="progress-bar bg-success" role="progressbar"
                                     th:style="|width:${budget.incomeCompletionPercent}%|"
                                     th:aria-valuenow="${budget.incomeCompletionPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card dashboard-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0" th:text="#{dashboard.periodComparison.title}">Period comparison</h5>
                            <span class="text-muted small" th:text="#{dashboard.periodComparison.subtitle}">Daily totals</span>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="trendChart" height="260"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card dashboard-card" th:if="${dashboard != null}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0" th:text="#{dashboard.recentTransactions.title}">Recent transactions</h5>
                    <a class="btn md-btn md-btn-outline md-btn-outline-primary md-btn-sm" th:href="@{/transactions}" th:text="#{dashboard.recentTransactions.viewAll}">View all</a>
                </div>
                <div th:if="${#lists.isEmpty(dashboard.recentTransactions)}" class="text-muted"
                     th:text="#{dashboard.recentTransactions.empty}">
                    You haven't recorded any transactions yet.
                </div>
                <div th:each="tx : ${dashboard.recentTransactions}" class="recent-transaction">
                    <div>
                        <div class="fw-semibold" th:text="${tx.categoryName}">Groceries</div>
                        <div class="text-muted small" th:text="|${tx.accountName} • ${tx.dateLabel}|">Main account</div>
                    </div>
                    <div class="fw-semibold"
                         th:classappend="${tx.direction?.name() == 'DECREASE'} ? ' amount-negative' : ' amount-positive'">
                        <span th:text="|${tx.direction?.name() == 'DECREASE' ? '-' : '+'}${#numbers.formatDecimal(tx.amount, 1, 'COMMA', 2, 'POINT')} ${tx.currency}|"></span>
                        <div class="text-muted small"
                             th:if="${tx.currency != null and tx.currency != dashboard.baseCurrency}"
                             th:text="|≈ ${#numbers.formatDecimal(tx.amountInBase, 1, 'COMMA', 2, 'POINT')} ${dashboard.baseCurrency}|"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
            crossorigin="anonymous"></script>
    <script th:src="@{/webjars/chart.js/dist/chart.umd.js}"></script>
    <script th:if="${dashboard != null}" th:inline="javascript">
/*<![CDATA[*/
    const breakdownButtons = document.querySelectorAll('[data-breakdown]');
    const breakdownCanvas = document.getElementById('breakdownChart');
    const trendCanvas = document.getElementById('trendChart');
    const breakdownListEl = document.getElementById('breakdownList');

    const chartJsAvailable = typeof Chart !== 'undefined';

    const i18n = {
        amountLabel: /*[[#{dashboard.chart.amount}]]*/ 'Amount',
        expensesLabel: /*[[#{common.expenses}]]*/ 'Expenses',
        incomeLabel: /*[[#{common.income}]]*/ 'Income',
        noData: /*[[#{dashboard.breakdown.empty}]]*/ 'No data available for this selection.',
        other: /*[[#{dashboard.breakdown.other}]]*/ 'Other'
    };

    const baseCurrency = /*[[${dashboard.baseCurrency}]]*/ 'USD';

    const expenseBreakdownRaw = /*[[${dashboard.expenseBreakdown}]]*/ [];
    const incomeBreakdownRaw = /*[[${dashboard.incomeBreakdown}]]*/ [];
    const expenseTrendRaw = /*[[${dashboard.expenseTrend}]]*/ [];
    const incomeTrendRaw = /*[[${dashboard.incomeTrend}]]*/ [];

    const expenseBreakdown = Array.isArray(expenseBreakdownRaw) ? expenseBreakdownRaw : [];
    const incomeBreakdown = Array.isArray(incomeBreakdownRaw) ? incomeBreakdownRaw : [];
    const expenseTrend = Array.isArray(expenseTrendRaw) ? expenseTrendRaw : [];
    const incomeTrend = Array.isArray(incomeTrendRaw) ? incomeTrendRaw : [];

    const colorPalette = ['#dc3545', '#fd7e14', '#ffc107', '#0d6efd', '#20c997', '#6f42c1'];

    function normaliseAmount(value) {
        const numeric = Number(value);
        return Number.isFinite(numeric) ? numeric : 0;
    }

    function formatAmount(value, options) {
        const formatOptions = options ?? {minimumFractionDigits: 2, maximumFractionDigits: 2};
        return normaliseAmount(value).toLocaleString(undefined, formatOptions);
    }

    let breakdownChart = null;
    const breakdownCtx = breakdownCanvas ? breakdownCanvas.getContext('2d') : null;
    if (breakdownCtx && chartJsAvailable) {
        breakdownChart = new Chart(breakdownCtx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    label: `${i18n.amountLabel} (${baseCurrency})`,
                    data: [],
                    backgroundColor: colorPalette,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    let trendChart = null;
    if (trendCanvas && chartJsAvailable) {
        const trendCtx = trendCanvas.getContext('2d');
        trendChart = new Chart(trendCtx, {
            type: 'bar',
            data: {
                labels: expenseTrend.map(point => point.label),
                datasets: [
                    {
                        label: `${i18n.expensesLabel} (${baseCurrency})`,
                        data: expenseTrend.map(point => normaliseAmount(point.amount)),
                        backgroundColor: 'rgba(220,53,69,0.4)',
                        borderColor: 'rgba(220,53,69,1)',
                        borderWidth: 1
                    },
                    {
                        label: `${i18n.incomeLabel} (${baseCurrency})`,
                        data: incomeTrend.map(point => normaliseAmount(point.amount)),
                        backgroundColor: 'rgba(25,135,84,0.4)',
                        borderColor: 'rgba(25,135,84,1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return formatAmount(value, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function renderBreakdown(type) {
        const selected = type === 'income' ? incomeBreakdown : expenseBreakdown;
        const dataset = Array.isArray(selected) ? selected : [];
        if (breakdownChart) {
            breakdownChart.data.labels = dataset.map(item => item.name ?? i18n.other);
            breakdownChart.data.datasets[0].data = dataset.map(item => normaliseAmount(item.amount));
            const label = type === 'income' ? i18n.incomeLabel : i18n.expensesLabel;
            breakdownChart.data.datasets[0].label = `${label} (${baseCurrency})`;
            breakdownChart.data.datasets[0].backgroundColor = dataset.length
                ? dataset.map((_, idx) => colorPalette[idx % colorPalette.length])
                : colorPalette;
            breakdownChart.update();
        }
        if (breakdownListEl) {
            breakdownListEl.innerHTML = '';
            if (!dataset.length) {
                const emptyState = document.createElement('p');
                emptyState.className = 'text-muted mb-0';
                emptyState.textContent = i18n.noData;
                breakdownListEl.appendChild(emptyState);
            } else {
                dataset.forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'd-flex justify-content-between align-items-center breakdown-row';
                    const name = document.createElement('span');
                    name.className = 'fw-semibold';
                    name.textContent = item.name ?? i18n.other;
                    const amount = document.createElement('span');
                    amount.className = 'text-muted';
                    amount.textContent = `${formatAmount(item.amount, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ${baseCurrency}`;
                    row.appendChild(name);
                    row.appendChild(amount);
                    breakdownListEl.appendChild(row);
                });
            }
        }
    }

    renderBreakdown('expenses');

    breakdownButtons.forEach(button => {
        button.addEventListener('click', () => {
            breakdownButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            renderBreakdown(button.dataset.breakdown);
        });
    });
/*]]>*/
</script>
</body>
</html>
