<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="#{support.form.title}">Support</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="icon" type="image/png" href="/images/my-logo.png" th:href="@{/images/my-logo.png}"/>
</head>
<body>
<div th:replace="blocks/header.html :: menu"></div>

<main class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 th:text="#{support.form.heading}">Contact support</h1>

            <div th:if="${successMessage}" class="alert alert-success" role="alert" data-support-success>
                <span th:text="${successMessage}">Your request has been sent.</span>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                <span th:text="${errorMessage}">Please correct the highlighted fields.</span>
            </div>

            <form id="supportForm" th:action="@{/support}" th:object="${supportRequest}" method="post" novalidate>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="mb-3">
                    <label for="email" class="form-label" th:text="#{support.form.email.label}">Email</label>
                    <input type="email" class="form-control" id="email" th:field="*{email}"
                           th:placeholder="#{support.form.email.placeholder}" required>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
                </div>

                <div class="mb-3">
                    <label for="subject" class="form-label" th:text="#{support.form.subject.label}">Subject</label>
                    <input type="text" class="form-control" id="subject" th:field="*{subject}"
                           th:placeholder="#{support.form.subject.placeholder}" required>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('subject')}" th:errors="*{subject}"></div>
                </div>

                <div class="mb-3">
                    <label for="message" class="form-label" th:text="#{support.form.message.label}">Message</label>
                    <textarea class="form-control" id="message" rows="6" th:field="*{message}"
                              th:placeholder="#{support.form.message.placeholder}" required></textarea>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('message')}" th:errors="*{message}"></div>
                </div>

                <button type="submit" class="btn md-btn md-btn-primary" th:text="#{support.form.submit}">Send</button>
            </form>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
<script>
    (function () {
        const form = document.getElementById('supportForm');
        if (!form || typeof window === 'undefined') {
            return;
        }

        const storageKey = 'supportFormDraft';
        const fields = ['email', 'subject', 'message'];

        function readDraft() {
            try {
                const raw = window.sessionStorage.getItem(storageKey);
                return raw ? JSON.parse(raw) : {};
            } catch (error) {
                console.warn('Failed to read support form draft', error);
                return {};
            }
        }

        function persistDraft(draft) {
            try {
                window.sessionStorage.setItem(storageKey, JSON.stringify(draft));
            } catch (error) {
                console.warn('Failed to persist support form draft', error);
            }
        }

        const draft = readDraft();
        fields.forEach((name) => {
            const input = form.querySelector(`[name="${name}"]`);
            if (!input) {
                return;
            }
            if (Object.prototype.hasOwnProperty.call(draft, name)) {
                input.value = draft[name];
            }
            input.addEventListener('input', () => {
                draft[name] = input.value;
                persistDraft(draft);
            });
        });

        form.addEventListener('submit', () => {
            window.sessionStorage.removeItem(storageKey);
        });

        const successAlert = document.querySelector('[data-support-success]');
        if (successAlert) {
            window.sessionStorage.removeItem(storageKey);
        }
    })();
</script>
</body>
</html>
