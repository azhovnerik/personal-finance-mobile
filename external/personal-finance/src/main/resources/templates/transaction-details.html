<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title th:text="#{transactions.form.edit.title}">Edit transaction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!--    <link rel="stylesheet"-->
    <!--          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/css/bootstrap-datepicker3.css">-->
    <link href="/css/dashboard.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/images/my-logo.png" th:href="@{/images/my-logo.png}"/>

</head>
<body data-confirm-delete-title="Confirm deletion"
      data-confirm-delete-message="Are you sure you want to delete this item?"
      data-confirm-delete-confirm="Delete"
      data-confirm-delete-cancel="Cancel"
      th:attr="data-confirm-delete-title=#{common.confirmDeletionTitle}, data-confirm-delete-message=#{common.confirmDeletionMessage}, data-confirm-delete-confirm=#{common.delete}, data-confirm-delete-cancel=#{common.cancel}">
<div th:replace="blocks/header.html :: menu"></div>


<div class="container mt-5 mb-3">

    <h1 th:text="#{transactions.form.edit.heading}">Edit transaction</h1>
    <form th:object="${transaction}" th:method="put" th:action="@{/transactions/{id}(id=${transaction.id})}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <input type="hidden" name="returnUrl" th:value="${returnUrl}"/>
        <!--        <div class="input-append date" id="datepicker"
                     data-date-format="dd-mm-yyyy">-->
        <label for="datepicker" class="form-label" th:text="#{transactions.form.date.label}">Date</label>
        <input type="text" id="datepicker" th:field="*{date}" name="date"
               class="form-control bg-white datepicker" data-enable-time=true data-enable-seconds=true
               th:placeholder="#{transactions.form.date.placeholder}"><br>
        <span class="add-on"><i class="icon-th"></i></span>
        <p style="color:red" th:each="error: ${#fields.errors('date')}"
           th:text="${error}">Validation error</p>
        <!--        </div>-->
        <div th:if="${transaction.category} != null">
            <label for="category" th:text="#{transactions.form.category.label}">Category</label><br>
            <select  id="category" class="custom-select" th:field="*{category}">
                <option value="" disabled th:text="#{transactions.form.category.expenseHeading}">Категории затрат</option>
                <th:block th:each="group : ${expenseCategoriesToChoose}">
                    <optgroup th:if="${group.hasLabel()}" th:label="${group.label}">
                        <option th:each="c : ${group.categories}" th:value="${c.id}" th:text="${c.name}"
                                th:selected="${c.id==currentCategory.id}"
                                th:attr="data-category-type=${c.type}"></option>
                    </optgroup>
                    <th:block th:if="${!group.hasLabel()}">
                        <option th:each="c : ${group.categories}" th:value="${c.id}" th:text="${c.name}"
                                th:selected="${c.id==currentCategory.id}"
                                th:attr="data-category-type=${c.type}"></option>
                    </th:block>
                </th:block>
                <option th:if="${!incomeCategoriesToChoose.isEmpty()}" value="" disabled>──────────</option>
                <option th:if="${!incomeCategoriesToChoose.isEmpty()}" value="" disabled th:text="#{transactions.form.category.incomeHeading}">Категории доходов</option>
                <th:block th:each="group : ${incomeCategoriesToChoose}">
                    <optgroup th:if="${group.hasLabel()}" th:label="${group.label}">
                        <option th:each="c : ${group.categories}" th:value="${c.id}" th:text="${c.name}"
                                th:selected="${c.id==currentCategory.id}"
                                th:attr="data-category-type=${c.type}"></option>
                    </optgroup>
                    <th:block th:if="${!group.hasLabel()}">
                        <option th:each="c : ${group.categories}" th:value="${c.id}" th:text="${c.name}"
                                th:selected="${c.id==currentCategory.id}"
                                th:attr="data-category-type=${c.type}"></option>
                    </th:block>
                </th:block>
            </select>
            <br><br>
        </div>
        <label for="account" th:text="#{transactions.form.account.label}">Account</label><br>
        <select id="account" class="custom-select" th:field="*{account}">
            <option th:each="a : ${accounts}" th:value="${a.id}" th:text="${a.name + ' (' + a.currency + ')'}"
                    th:selected="${a.id==currentAccount.id}"></option>
        </select>
        <p style="color:red" th:each="error: ${#fields.errors('category')}"
           th:text="${error}">Validation error</p>
        <br><br>
        <label for="amount" th:text="#{transactions.form.amount.label}">Amount</label>
        <input type="number" name="amount" id="amount" th:field="*{amount}"
               class="form-control" th:placeholder="#{transactions.form.amount.placeholder}"><br>
        <small class="text-muted" th:text="#{transactions.form.amount.hint}">Amount will be saved in the selected account currency.</small>

        <div th:if="${errorMessage}" style="color:red">
            <div th:text="${errorMessage}"></div>
        </div>
        <input  name="type" id="type" placeholder="type" th:field="*{type}"
                class="form-control" type="hidden">
        <input  name="direction" id="direction" placeholder="direction" th:field="*{direction}"
                class="form-control" type="hidden">
        <label for="comment" th:text="#{transactions.form.comment.label}">comment</label>
        <input type="text" id="comment" name="comment" th:field="*{comment}"
                class="form-control" th:placeholder="#{transactions.form.comment.placeholder}"><br>
        <p style="color:red" th:each="error: ${#fields.errors('comment')}"
           th:text="${error}">Validation error</p>
        <!--        <input type="hidden" id="type" name="comment" placeholder="comment" th:field="*{type}"-->
        <!--               class="form-control"><br>-->
        <button type="submit" class="btn md-btn md-btn-success" th:text="#{common.save}">Save</button>
    </form>
    <br>
    <form th:action="@{/transactions/{id}(id=${transaction.id})}" th:method="delete" th:object="${transaction}"
          data-confirm-delete>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <input type="hidden" name="returnUrl" th:value="${returnUrl}"/>
        <button type="submit" class="btn md-btn md-btn-danger" th:text="#{common.delete}">Delete</button>
    </form>


</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js" type="text/javascript"></script>
<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="Stylesheet"
      type="text/css"/>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
        integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
<script defer th:src="@{/js/confirm-delete.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
        integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.2.0/js/bootstrap-datepicker.min.js"></script>-->

<script type="text/javascript">

    $("#datepicker").flatpickr({
        enableTime: true,
        dateFormat: "Y-m-d H:i:S",
        enableSeconds: true,
        disableMobile: true,
        // minViewMode: "days",
        autoclose: true
    });
</script>
<script type="text/javascript">
    const categorySelect = document.getElementById('category');
    const typeInput = document.getElementById('type');
    const directionInput = document.getElementById('direction');

    function updateTypeAndDirection() {
        if (!categorySelect || !typeInput || !directionInput) {
            return;
        }
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const categoryType = selectedOption ? selectedOption.getAttribute('data-category-type') : null;
        if (categoryType === 'INCOME') {
            typeInput.value = 'INCOME';
            directionInput.value = 'INCREASE';
        } else {
            typeInput.value = 'EXPENSE';
            directionInput.value = 'DECREASE';
        }
    }

    if (categorySelect) {
        categorySelect.addEventListener('change', updateTypeAndDirection);
        updateTypeAndDirection();
    }
</script>
</body>
</html>
